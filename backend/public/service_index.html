<html>

<head>
  <title>SERVICE_INDEX</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
</head>

<body>
  <h1>SERVICE_INDEX</h1>
  <button id="openSub">open sub</button>
  <button id="startWorker">start Worker</button>
  <button id="stopWorker">stop Worker</button>
  <h1 id="error"></h1>

  <script>
    let isWorking = false;

    // ====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====
    const dowork = () => {
      fetch('/log?page=service_index')
      .then((response) => {
        console.log(response); 
      })
      .catch((error) => {
        console.log(`Error: ${error}`);
      })
    }

    const loopFunc = (callback) => {
      if (isWorking) {
        dowork();
        fetch('/delay')
        .then((response) => {
          console.log(response); 
          callback(callback);
        })
        .catch((error) => {
          console.log(`Error: ${error}`);
        })
      }
    }
    

    // ====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====.====


    if ('serviceWorker' in navigator) {
      
      let msg = "";
      const startWorker = async () => {
        try {
            const registration = await navigator.serviceWorker.register('/service_worker.js', { scope: '/' })
            if (registration.installing) {
                console.log("Service worker installing");
                msg = "Service worker installing"
            } else if (registration.waiting) {
                console.log("Service worker installed");
                msg = "Service worker installed"
            } else if (registration.active) {
                console.log("Service worker active");
                msg = "Service worker active"
            }
        }
        catch (error) {
            console.log(`Error: ${error}`);
            msg = `Error: ${error}`
        }
        document.getElementById('error').innerHTML = msg;

        isWorking = true;
        loopFunc(loopFunc);
      }
      document.getElementById('startWorker').addEventListener('click', startWorker);
      
      const stopWorker = () => {
        isWorking = false;
      }
      document.getElementById('stopWorker').addEventListener('click', stopWorker);
      
    } else {
      console.log('Web Worker is not supported in this browser.');
      document.getElementById('error').innerHTML = 'Web Worker is not supported in this browser.';
    }
    

    const openSub = () =>
    {
      window.open(
          '/sub',
          '_blank',
          'toolbar=0, menubar=no',
      );
    }
    document.getElementById('openSub').addEventListener('click', openSub);

    

    // setInterval(() => {
    //   dowork();
    // }, 5000);
    
    
  </script>
</body>

</html>